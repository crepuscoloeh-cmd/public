<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini活动记录分组工具</title>
  
  <style>
    :root {
      --primary-blue: #A0C4DD;
      --primary-pink: #E5B8D1;
      --light-blue: #D8EAF5;
      --light-pink: #F5E0ED;
      --accent-blue: #8FB8D4;
      --accent-pink: #DBA5C9;
      --text-primary: #4A4A58;
      --text-secondary: #7A7A88;
      --bg-primary: #FAFAFA;
      --bg-secondary: #F5F5F7;
      --border: #D8D8E8;
      --shadow: 0 2px 12px rgba(0,0,0,0.06);
      --radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, sans-serif;
      background: linear-gradient(135deg, var(--light-blue) 0%, var(--light-pink) 100%);
      min-height: 100vh; 
      padding: 16px;
      line-height: 1.6;
      color: var(--text-primary);
    }
    
    .container { 
      max-width: 900px; 
      margin: 0 auto; 
      background: var(--bg-primary); 
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.08); 
      overflow: hidden;
    }
    
    .header { 
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-pink) 100%); 
      color: white; 
      padding: 20px 24px; 
      text-align: center;
    }
    
    .header h1 { 
      font-size: 1.2em;
      font-weight: 700; 
      margin-bottom: 4px;
    }
    
    .header p {
      font-size: 0.8em;
      opacity: 0.95;
    }
    
    /* 功能设置区域 */
    .controls-section { 
      padding: 16px; 
      background: white;
      border-bottom: 2px solid var(--border);
    }
    
    .section-title {
      font-size: 0.9em;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .id-settings {
      background: linear-gradient(135deg, var(--light-blue) 0%, var(--light-pink) 100%);
      padding: 12px;
      border-radius: var(--radius);
      margin-bottom: 12px;
      border: 2px solid var(--border);
    }
    
    .id-settings h3 {
      font-size: 0.8em;
      margin-bottom: 10px;
      color: var(--text-primary);
    }
    
    .id-settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
    }
    
    .id-input-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .id-input-group label {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.75em;
    }
    
    .id-input-group input {
      padding: 8px 12px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      background: white;
      transition: var(--transition);
    }
    
    .id-input-group input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(160, 196, 221, 0.2);
    }
    
    .control-group { 
      display: flex; 
      gap: 10px; 
      align-items: center; 
      flex-wrap: wrap; 
      margin: 10px 0;
    }
    
    .control-group label { 
      font-weight: 600; 
      min-width: 100px; 
      font-size: 0.8em;
    }
    
    select, input[type="number"] { 
      padding: 8px 12px; 
      border: 2px solid var(--border); 
      border-radius: 10px; 
      font-size: 13px;
      transition: var(--transition);
      background: white;
      flex: 1;
      min-width: 160px;
    }
    
    select:focus, input:focus { 
      outline: none; 
      border-color: var(--primary-blue); 
      box-shadow: 0 0 0 3px rgba(160, 196, 221, 0.2);
    }
    
    select { 
      cursor: pointer;
    }
    
    #customDaysInput {
      display: none;
      animation: fadeIn 0.3s ease-in;
    }
    
    #customDaysInput.show {
      display: flex;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* 上传区域 */
    .upload-section { 
      padding: 16px; 
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border);
    }
    
    .upload-area { 
      border: 3px dashed var(--primary-blue); 
      border-radius: 12px; 
      padding: 20px 16px; 
      cursor: pointer;
      transition: var(--transition); 
      background: white; 
      text-align: center;
    }
    
    .upload-area:hover, .upload-area.dragover { 
      border-color: var(--primary-pink); 
      background: var(--light-pink); 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(229, 184, 209, 0.3);
    }
    
    .upload-icon { 
      font-size: 32px; 
      margin-bottom: 8px;
      color: var(--primary-blue);
    }
    
    .upload-area h3 {
      font-size: 0.9em;
      margin-bottom: 4px;
      font-weight: 600;
    }
    
    .upload-subtitle {
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-size: 0.7em;
    }
    
    #fileInput { display: none; }
    
    .file-status {
      margin-top: 10px;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 500;
      font-size: 0.8em;
      display: none;
    }
    
    .file-status.show {
      display: block;
    }
    
    .file-status.success {
      background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
      color: #2E7D32;
      border-left: 4px solid #4CAF50;
    }
    
    .file-status.error {
      background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
      color: #C62828;
      border-left: 4px solid #F44336;
    }
    
    /* 按钮 */
    button { 
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-pink) 100%); 
      color: white; 
      border: none; 
      cursor: pointer; 
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 13px;
      transition: var(--transition);
      box-shadow: 0 3px 10px rgba(160, 196, 221, 0.3);
      width: 100%;
      margin-top: 10px;
    }
    
    button:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 5px 16px rgba(160, 196, 221, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
      transform: none;
    }
    
    /* 进度区域 */
    .progress-section {
      padding: 16px;
      background: white;
      border-bottom: 2px solid var(--border);
      display: none;
    }
    
    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: var(--bg-secondary);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-pink) 100%);
      transition: width 0.3s ease;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7em;
      color: white;
      font-weight: 600;
    }
    
    .progress-text {
      font-size: 0.8em;
      color: var(--text-secondary);
      text-align: center;
    }
    
    /* 结果区域 */
    .results-section {
      padding: 16px;
      background: white;
      display: none;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, var(--light-blue) 0%, var(--light-pink) 100%);
      padding: 14px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid var(--border);
    }
    
    .stat-value {
      font-size: 1.6em;
      font-weight: 700;
      color: var(--text-primary);
      display: block;
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 0.7em;
      color: var(--text-secondary);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .file-list {
      max-height: 500px;
      overflow-y: auto;
      margin-bottom: 12px;
    }
    
    .file-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .file-list::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 3px;
    }
    
    .file-list::-webkit-scrollbar-thumb {
      background: var(--primary-blue);
      border-radius: 3px;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: white;
      border: 2px solid var(--border);
      border-radius: 10px;
      margin-bottom: 10px;
      transition: var(--transition);
    }
    
    .file-item:hover {
      border-color: var(--primary-blue);
      box-shadow: 0 2px 8px rgba(160, 196, 221, 0.2);
    }
    
    .file-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .file-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    
    .file-icon {
      color: var(--primary-blue);
      flex-shrink: 0;
    }
    
    .file-details {
      flex: 1;
      min-width: 0;
    }
    
    .file-details h3 {
      font-size: 0.85em;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .file-meta {
      font-size: 0.7em;
      color: var(--text-secondary);
    }
    
    .file-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .file-item button {
      width: auto;
      margin: 0;
      padding: 6px 14px;
      font-size: 0.75em;
    }
    
    .preview-btn {
      background: linear-gradient(135deg, var(--accent-blue) 0%, var(--primary-blue) 100%);
    }
    
    .download-btn {
      background: linear-gradient(135deg, var(--accent-pink) 0%, var(--primary-pink) 100%);
    }
    
    .batch-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    
    .batch-actions button {
      flex: 1;
      min-width: 140px;
      font-size: 0.8em;
    }
    
    /* 日志区域 - 可折叠 */
    .log-section {
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border);
    }
    
    .log-header {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      transition: var(--transition);
    }
    
    .log-header:hover {
      background: rgba(160, 196, 221, 0.1);
    }
    
    .log-header h3 {
      font-size: 0.9em;
      color: var(--text-primary);
    }
    
    .log-toggle {
      font-size: 0.8em;
      color: var(--text-secondary);
      transition: transform 0.3s ease;
    }
    
    .log-toggle.collapsed {
      transform: rotate(-90deg);
    }
    
    .log-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      font-family: 'Courier New', monospace;
      font-size: 0.7em;
      line-height: 1.4;
    }
    
    .log-body.show {
      max-height: 200px;
      overflow-y: auto;
      padding: 12px 16px;
    }
    
    .log-body::-webkit-scrollbar {
      width: 6px;
    }
    
    .log-body::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }
    
    .log-body::-webkit-scrollbar-thumb {
      background: var(--primary-blue);
      border-radius: 3px;
    }
    
    .log-entry {
      padding: 4px 0;
      color: var(--text-secondary);
    }
    
    .log-entry.error {
      color: #C62828;
    }
    
    .log-entry.success {
      color: #2E7D32;
    }
    
    .log-entry.info {
      color: #1976D2;
    }
    
    /* 使用说明 - 可折叠 */
    .info-section {
      background: white;
      border-bottom: 2px solid var(--border);
    }
    
    .info-header {
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      transition: var(--transition);
    }
    
    .info-header:hover {
      background: rgba(160, 196, 221, 0.1);
    }
    
    .info-header h3 {
      font-size: 0.9em;
      color: var(--text-primary);
    }
    
    .info-toggle {
      font-size: 0.8em;
      color: var(--text-secondary);
      transition: transform 0.3s ease;
    }
    
    .info-toggle.collapsed {
      transform: rotate(-90deg);
    }
    
    .info-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .info-body.show {
      max-height: 800px;
      overflow-y: auto;
      padding: 12px 16px;
    }
    
    .info-body::-webkit-scrollbar {
      width: 6px;
    }
    
    .info-body::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }
    
    .info-body::-webkit-scrollbar-thumb {
      background: var(--primary-blue);
      border-radius: 3px;
    }
    
    .info-body p {
      margin-bottom: 12px;
      font-size: 0.85em;
      line-height: 1.6;
    }
    
    .info-body strong {
      color: var(--text-primary);
    }
    
    .info-body ol {
      margin-left: 20px;
      margin-bottom: 12px;
    }
    
    .info-body li {
      margin-bottom: 8px;
      font-size: 0.8em;
      line-height: 1.5;
    }
    
    .info-body a {
      color: var(--primary-blue);
      text-decoration: underline;
    }
    
    /* 预览模态框 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .modal-content {
      background-color: var(--bg-primary);
      margin: 3% auto;
      width: 85%;
      max-width: 900px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    
    .modal-header {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-pink) 100%);
      color: white;
      padding: 16px 20px;
      border-radius: 20px 20px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      font-size: 1em;
      margin-bottom: 6px;
    }
    
    .modal-stats {
      color: rgba(255,255,255,0.9);
      font-size: 0.8em;
    }
    
    .modal-body {
      padding: 16px 20px;
      overflow-y: auto;
      flex: 1;
    }
    
    .modal-body::-webkit-scrollbar {
      width: 6px;
    }
    
    .modal-body::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }
    
    .modal-body::-webkit-scrollbar-thumb {
      background: var(--primary-blue);
      border-radius: 3px;
    }
    
    .modal-footer {
      padding: 12px 20px;
      border-top: 2px solid var(--border);
      display: flex;
      justify-content: flex-end;
      background: var(--bg-secondary);
      border-radius: 0 0 20px 20px;
    }
    
    .close {
      color: white;
      float: right;
      font-size: 28px;
      font-weight: 300;
      line-height: 1;
      cursor: pointer;
      transition: var(--transition);
      opacity: 0.8;
    }
    
    .close:hover {
      opacity: 1;
      transform: rotate(90deg);
    }
    
    .conversation-item {
      background: white;
      padding: 14px;
      border-radius: 10px;
      margin-bottom: 10px;
      box-shadow: var(--shadow);
      border: 2px solid var(--border);
    }
    
    .conversation-header {
      color: var(--text-secondary);
      font-weight: 600;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 2px solid var(--border);
      font-size: 0.75em;
    }
    
    .message-bubble {
      margin: 10px 0;
      padding: 10px 14px;
      border-radius: 10px;
    }
    
    .user-bubble {
      background: linear-gradient(135deg, var(--light-blue) 0%, #F0F8FF 100%);
      border-left: 3px solid var(--primary-blue);
    }
    
    .ai-bubble {
      background: linear-gradient(135deg, var(--light-pink) 0%, #FFF0F8 100%);
      border-left: 3px solid var(--primary-pink);
    }
    
    .system-bubble {
      background: linear-gradient(135deg, #F5F5F7 0%, #FAFAFA 100%);
      border-left: 3px solid var(--text-secondary);
    }
    
    .message-label {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 0.7em;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .message-content {
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: var(--text-primary);
      font-size: 0.8em;
    }
    
    @media (max-width: 768px) {
      body { padding: 10px; }
      .header { padding: 18px 16px; }
      .controls-section, .upload-section, .results-section { padding: 14px; }
      .control-group { flex-direction: column; align-items: stretch; }
      .control-group label { min-width: auto; }
      .file-item { flex-direction: column; align-items: stretch; }
      .file-actions { width: 100%; }
      .file-item button { width: 100%; }
      .modal-content { width: 95%; margin: 5% auto; }
      .stats { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Gemini活动记录分组工具</h1>
      <p>智能解析 · 按时间分组 · 批量导出</p>
    </div>
    
    <!-- 功能设置区域 -->
    <div class="controls-section">
      <h2 class="section-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m5.2-13.8l-4.2 4.2m0 5.2l-4.2 4.2m11.8-9.2h-6m-6 0H1m13.8-5.2l-4.2 4.2m-5.2 0L1 1"/>
        </svg>
        功能设置
      </h2>
      
      <!-- ID自定义设置 -->
      <div class="id-settings">
        <h3>自定义角色名称</h3>
        <div class="id-settings-grid">
          <div class="id-input-group">
            <label for="userIdInput">用户名称:</label>
            <input type="text" id="userIdInput" placeholder="User" value="User">
          </div>
          <div class="id-input-group">
            <label for="assistantIdInput">助手名称:</label>
            <input type="text" id="assistantIdInput" placeholder="Gemini" value="Gemini">
          </div>
        </div>
      </div>
      
      <div class="control-group">
        <label for="timeInterval">时间分组间隔:</label>
        <select id="timeInterval">
          <option value="1">1天</option>
          <option value="3">3天</option>
          <option value="7" selected>7天</option>
          <option value="14">14天</option>
          <option value="30">30天</option>
          <option value="custom">自定义天数</option>
        </select>
      </div>
      
      <div class="control-group" id="customDaysInput">
        <label for="customDays">自定义天数:</label>
        <input type="number" id="customDays" min="1" max="365" placeholder="输入1-365之间的天数">
      </div>
    </div>
    
    <!-- 上传区域 -->
    <div class="upload-section">
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
        </div>
        <h3>拖拽或点击上传文件</h3>
        <p class="upload-subtitle">支持从Google我的活动导出的HTML文件</p>
      </div>
      
      <input type="file" id="fileInput" accept=".html,.htm">
      <div id="fileStatus" class="file-status"></div>
      
      <button id="processBtn">开始处理</button>
    </div>
    
    <!-- 进度区域 -->
    <div class="progress-section" id="progressSection">
      <h2 class="section-title" style="margin-bottom: 12px;">处理进度</h2>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar">0%</div>
      </div>
      <div class="progress-text" id="progressText">准备中...</div>
    </div>
    
    <!-- 结果区域 -->
    <div class="results-section" id="resultsSection">
      <h2 class="section-title" style="margin-bottom: 12px;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
        </svg>
        处理结果
      </h2>
      
      <div class="stats">
        <div class="stat-card">
          <span class="stat-value" id="totalConversations">0</span>
          <span class="stat-label">总对话数</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="totalFiles">0</span>
          <span class="stat-label">生成文件数</span>
        </div>
        <div class="stat-card" style="grid-column: span 2;">
          <span class="stat-value" id="dateRange" style="font-size: 0.9em;">-</span>
          <span class="stat-label">时间范围</span>
        </div>
      </div>
      
      <div class="file-list" id="fileList"></div>
      
      <div class="batch-actions">
        <button onclick="selectAllFiles()">全选</button>
        <button onclick="deselectAllFiles()">取消全选</button>
        <button onclick="downloadSelectedFiles()">下载选中 (<span id="selectedCount">0</span>)</button>
        <button onclick="downloadAllFiles()">下载全部</button>
      </div>
    </div>
    
    <!-- 日志区域 -->
    <div class="log-section">
      <div class="log-header" onclick="toggleLog()">
        <h3>处理日志</h3>
        <span class="log-toggle" id="logToggle">▼</span>
      </div>
      <div class="log-body" id="logBody"></div>
    </div>
    
    <!-- 使用说明 -->
    <div class="info-section">
      <div class="info-header" onclick="toggleInfo()">
        <h3>使用说明</h3>
        <span class="info-toggle" id="infoToggle">▼</span>
      </div>
      <div class="info-body" id="infoBody">
        <p><strong>如何获取Gemini活动记录:</strong></p>
        <ol>
          <li>访问 <a href="https://myaccount.google.com" target="_blank">myaccount.google.com</a></li>
          <li>点击"数据和隐私设置"</li>
          <li>选择"下载您的数据"</li>
          <li>在产品列表中勾选"我的活动"（注意：Gemini Apps选项只包含指令不包含聊天内容，请务必选择"我的活动"）</li>
          <li>导出格式选择HTML，下载并解压文件</li>
          <li>在解压后的文件夹中找到Gemini文件夹下的"我的活动记录.html"</li>
          <li>将该HTML文件上传到本工具</li>
        </ol>
        
        <p style="margin-top: 20px;"><strong>功能说明:</strong></p>
        <p>本工具完全在本地处理您的数据，不会上传到任何服务器。支持自定义时间分组间隔，自动转换时区为东八区（北京时间），并将对话记录按时间分组导出为TXT文件。可以选择全部下载或勾选部分文件下载。</p>
      </div>
    </div>
  </div>
  
  <!-- 预览模态框 -->
  <div id="previewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h2 id="modalTitle">对话记录预览</h2>
          <div class="modal-stats" id="modalStats">0 条对话</div>
        </div>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer">
        <button onclick="closeModal()" style="width: auto; padding: 8px 20px; font-size: 0.8em;">关闭</button>
      </div>
    </div>
  </div>

  <script>
    // DOM元素引用
    const $ = (selector) => document.querySelector(selector);
    const uploadArea = $('#uploadArea');
    const fileInput = $('#fileInput');
    const fileStatus = $('#fileStatus');
    const processBtn = $('#processBtn');
    const progressSection = $('#progressSection');
    const progressBar = $('#progressBar');
    const progressText = $('#progressText');
    const resultsSection = $('#resultsSection');
    const logBody = $('#logBody');
    const timeIntervalSelect = $('#timeInterval');
    const customDaysInput = $('#customDaysInput');
    const userIdInput = $('#userIdInput');
    const assistantIdInput = $('#assistantIdInput');
    
    let currentFile = null;
    let processedFiles = [];
    
    // 折叠功能
    function toggleLog() {
      const body = $('#logBody');
      const toggle = $('#logToggle');
      body.classList.toggle('show');
      toggle.classList.toggle('collapsed');
    }
    
    function toggleInfo() {
      const body = $('#infoBody');
      const toggle = $('#infoToggle');
      body.classList.toggle('show');
      toggle.classList.toggle('collapsed');
    }
    
    // 日志函数
    function log(message, type = 'info') {
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${type}`;
      logEntry.textContent = `[${new Date().toLocaleTimeString('zh-CN')}] ${message}`;
      logBody.appendChild(logEntry);
      logBody.scrollTop = logBody.scrollHeight;
      
      // 自动展开日志
      if (!logBody.classList.contains('show')) {
        logBody.classList.add('show');
        $('#logToggle').classList.remove('collapsed');
      }
    }
    
    // 显示文件状态
    function showFileStatus(message, type = 'success') {
      fileStatus.textContent = message;
      fileStatus.className = `file-status ${type} show`;
      setTimeout(() => {
        fileStatus.classList.remove('show');
      }, 5000);
    }
    
    // 更新进度
    function updateProgress(percent, text = '') {
      progressBar.style.width = `${percent}%`;
      progressBar.textContent = `${percent}%`;
      if (text) {
        progressText.textContent = text;
      }
    }
    
    // 文件上传交互
    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });
    
    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });
    
    function handleFiles(files) {
      if (files.length === 0) return;
      
      const file = files[0];
      if (!file.name.match(/\.(html|htm)$/i)) {
        showFileStatus('请上传HTML格式的文件', 'error');
        return;
      }
      
      currentFile = file;
      showFileStatus(`文件已加载: ${file.name}`, 'success');
      log(`文件已选择: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
    }
    
    // 时间间隔选择
    timeIntervalSelect.addEventListener('change', (e) => {
      if (e.target.value === 'custom') {
        customDaysInput.classList.add('show');
      } else {
        customDaysInput.classList.remove('show');
      }
    });
    
    // 解析HTML内容 - 带时区转换
    function parseConversations(htmlContent) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlContent, 'text/html');
      
      const conversations = [];
      const items = doc.querySelectorAll('.outer-cell');
      
      if (items.length === 0) {
        throw new Error('未找到有效的活动记录,请确保上传的是Google我的活动导出的HTML文件');
      }
      
      log(`找到 ${items.length} 个活动项目`);
      
      items.forEach((item, index) => {
        try {
          // 获取所有content-cell
          const contentCells = item.querySelectorAll('.content-cell');
          if (contentCells.length === 0) return;
          
          // 第一个content-cell包含用户消息和时间
          const userCell = contentCells[0];
          const textContent = userCell.textContent;
          
          // 解析时间 - 新版带时区标识
          const timeMatch = textContent.match(/(\d{4})年(\d{1,2})月(\d{1,2})日\s+(\d{1,2}):(\d{2}):(\d{2})\s+([A-Z]{3})/);
          if (!timeMatch) return;
          
          const [, year, month, day, hour, minute, second, timezone] = timeMatch;
          
          // 将PDT时间转换为东八区时间
          // PDT是UTC-7,东八区是UTC+8,差15小时
          let timestamp = new Date(year, month - 1, day, hour, minute, second);
          
          if (timezone === 'PDT' || timezone === 'PST') {
            // PDT(太平洋夏令时)是UTC-7,PST(太平洋标准时)是UTC-8
            // 转换为东八区需要加15小时(PDT)或16小时(PST)
            const hoursToAdd = timezone === 'PDT' ? 15 : 16;
            timestamp = new Date(timestamp.getTime() + hoursToAdd * 60 * 60 * 1000);
          }
          
          // 过滤未来时间
          const now = new Date();
          if (timestamp > now) {
            log(`跳过未来时间: ${timestamp.toLocaleString('zh-CN')}`, 'info');
            return;
          }
          
          // 提取用户消息
          const promptMatch = textContent.match(/Prompted\s+([\s\S]+?)\d{4}年/);
          let userMessage = '';
          if (promptMatch) {
            userMessage = promptMatch[1].trim();
          }
          
          // 提取AI消息
          let aiMessage = '';
          const pTags = userCell.querySelectorAll('p');
          pTags.forEach(p => {
            const pText = p.textContent.trim();
            if (pText && !pText.includes('Prompted') && !pText.includes('年') && !pText.includes('月') && !pText.includes('日')) {
              aiMessage += (aiMessage ? '\n' : '') + pText;
            }
          });
          
          // 检查是否是系统预设
          const isSystemPrompt = userMessage.includes('用自定义预设提示对') || userMessage.includes('设置"');
          
          // 只添加有内容的对话
          if (userMessage || aiMessage) {
            conversations.push({
              timestamp: timestamp,
              userMessage: userMessage.trim(),
              aiMessage: aiMessage.trim(),
              isSystemPrompt: isSystemPrompt
            });
          }
        } catch (error) {
          log(`解析第 ${index + 1} 项时出错: ${error.message}`, 'error');
        }
      });
      
      // 按时间排序(最旧的在前)
      conversations.sort((a, b) => a.timestamp - b.timestamp);
      
      log(`成功解析 ${conversations.length} 条对话`);
      return conversations;
    }
    
    // 按时间间隔分组
    function groupByTimeInterval(conversations, intervalDays) {
      if (conversations.length === 0) return [];
      
      const groups = [];
      let currentGroup = {
        startDate: conversations[0].timestamp,
        endDate: null,
        conversations: []
      };
      
      conversations.forEach(conv => {
        const daysDiff = (conv.timestamp - currentGroup.startDate) / (1000 * 60 * 60 * 24);
        
        if (daysDiff > intervalDays) {
          currentGroup.endDate = currentGroup.conversations[currentGroup.conversations.length - 1].timestamp;
          groups.push(currentGroup);
          
          currentGroup = {
            startDate: conv.timestamp,
            endDate: null,
            conversations: []
          };
        }
        
        currentGroup.conversations.push(conv);
      });
      
      // 添加最后一组
      if (currentGroup.conversations.length > 0) {
        currentGroup.endDate = currentGroup.conversations[currentGroup.conversations.length - 1].timestamp;
        groups.push(currentGroup);
      }
      
      return groups;
    }
    
    // 生成TXT文件
    function generateTXTFiles(groups, intervalDays) {
      const files = [];
      const userId = userIdInput.value || 'User';
      const assistantId = assistantIdInput.value || 'Gemini';
      
      groups.forEach((group, index) => {
        const startDate = formatDate(group.startDate);
        const endDate = formatDate(group.endDate);
        const filename = `Gemini对话记录_${startDate}${startDate !== endDate ? `_至_${endDate}` : ''}.txt`;
        
        let content = '';
        content += '='.repeat(80) + '\n';
        content += `  ${assistantId}对话记录\n`;
        content += `  时间范围: ${startDate}${startDate !== endDate ? ` 至 ${endDate}` : ''}\n`;
        content += `  对话总数: ${group.conversations.length}\n`;
        content += `  分组间隔: ${intervalDays}天\n`;
        content += '='.repeat(80) + '\n\n';
        
        group.conversations.forEach((conv, convIndex) => {
          // 时间已经在解析时转换为东八区,这里直接格式化
          const timestamp = new Date(conv.timestamp).toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });
          
          // 对话之间的分割线
          if (convIndex > 0) {
            content += '-'.repeat(80) + '\n\n';
          }
          
          // 时间戳(后面只有空行,没有分割线)
          content += `对话 ${convIndex + 1} | ${timestamp}\n\n`;
          
          // 用户消息
          if (conv.userMessage) {
            if (conv.isSystemPrompt) {
              content += `系统预设操作提示:\n${conv.userMessage}\n\n`;
            } else {
              content += `${userId}:\n${conv.userMessage}\n\n`;
            }
          }
          
          // AI消息
          if (conv.aiMessage) {
            content += `${assistantId}:\n${conv.aiMessage}\n\n`;
          }
        });
        
        content += '='.repeat(80) + '\n';
        content += '对话记录结束\n';
        content += '='.repeat(80) + '\n';
        
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        files.push({
          name: filename,
          url: url,
          startDate: startDate,
          endDate: endDate,
          count: group.conversations.length,
          group: group
        });
      });
      
      return files;
    }
    
    // 格式化日期
    function formatDate(date) {
      return new Date(date).toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      }).replace(/\//g, '-');
    }
    
    // 处理文件
    async function processFile() {
      if (!currentFile) {
        showFileStatus('请先上传文件', 'error');
        return;
      }
      
      processBtn.disabled = true;
      processBtn.textContent = '处理中...';
      progressSection.style.display = 'block';
      resultsSection.style.display = 'none';
      
      try {
        updateProgress(10, '读取文件中...');
        log('开始读取文件...');
        
        const htmlContent = await currentFile.text();
        log(`文件读取完成,大小: ${htmlContent.length} 字符`);
        
        updateProgress(30, '解析对话记录...');
        const conversations = parseConversations(htmlContent);
        
        if (conversations.length === 0) {
          throw new Error('未找到有效对话记录');
        }
        
        updateProgress(60, '分组处理中...');
        
        let intervalDays = 7;
        const selectedInterval = $('#timeInterval').value;
        
        if (selectedInterval !== 'custom') {
          intervalDays = parseInt(selectedInterval);
        }
        
        if ($('#timeInterval').value === 'custom') {
          const customDays = parseInt($('#customDays').value);
          if (!customDays || customDays <= 0 || customDays > 365) {
            throw new Error('请输入有效的自定义天数(1-365)');
          }
          intervalDays = customDays;
        }
        
        const groups = groupByTimeInterval(conversations, intervalDays);
        log(`分组完成,生成 ${groups.length} 个时间段`);
        
        updateProgress(85, '正在生成TXT文件...');
        processedFiles = generateTXTFiles(groups, intervalDays);
        
        updateProgress(100, '处理完成');
        showFileStatus('处理成功!文件已生成,可以下载了。', 'success');
        displayResults();
        
      } catch (error) {
        log(`处理失败: ${error.message}`, 'error');
        showFileStatus(`处理失败: ${error.message}`, 'error');
        updateProgress(0, '处理失败');
      } finally {
        processBtn.disabled = false;
        processBtn.textContent = '开始处理';
        setTimeout(() => {
          progressSection.style.display = 'none';
        }, 2000);
      }
    }

    // 显示结果
    function displayResults() {
      const totalConversations = processedFiles.reduce((sum, file) => sum + file.count, 0);
      
      $('#totalConversations').textContent = totalConversations;
      $('#totalFiles').textContent = processedFiles.length;
      
      if (processedFiles.length > 0) {
        const firstDate = processedFiles[0].startDate;
        const lastDate = processedFiles[processedFiles.length - 1].endDate;
        $('#dateRange').textContent = `${firstDate} - ${lastDate}`;
      }
      
      const fileList = $('#fileList');
      fileList.innerHTML = '';
      
      // 反转数组,最新的在上面
      const reversedFiles = [...processedFiles].reverse();
      
      reversedFiles.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        
        const originalIndex = processedFiles.indexOf(file);
        
        fileItem.innerHTML = `
          <div class="file-checkbox">
            <input type="checkbox" id="file-${originalIndex}" data-index="${originalIndex}" onchange="updateSelectedCount()">
          </div>
          <div class="file-info">
            <div class="file-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
              </svg>
            </div>
            <div class="file-details">
              <h3>${file.name}</h3>
              <div class="file-meta">时间: ${file.startDate} - ${file.endDate} | 对话数: ${file.count}</div>
            </div>
          </div>
          <div class="file-actions">
            <button class="preview-btn" onclick="previewFile(${originalIndex})">
              预览
            </button>
            <button class="download-btn" onclick="downloadFile('${file.url}', '${file.name}')">
              下载
            </button>
          </div>
        `;
        
        fileList.appendChild(fileItem);
      });
      
      updateSelectedCount();
      resultsSection.style.display = 'block';
      log(`结果展示完成,共 ${processedFiles.length} 个文件可供下载`);
    }
    
    // 更新选中数量
    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('.file-checkbox input[type="checkbox"]');
      const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const countSpan = $('#selectedCount');
      if (countSpan) {
        countSpan.textContent = selectedCount;
      }
    }
    
    // 全选
    function selectAllFiles() {
      const checkboxes = document.querySelectorAll('.file-checkbox input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = true);
      updateSelectedCount();
    }
    
    // 取消全选
    function deselectAllFiles() {
      const checkboxes = document.querySelectorAll('.file-checkbox input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = false);
      updateSelectedCount();
    }
    
    // 下载选中的文件
    function downloadSelectedFiles() {
      const checkboxes = document.querySelectorAll('.file-checkbox input[type="checkbox"]:checked');
      if (checkboxes.length === 0) {
        showFileStatus('请至少选择一个文件', 'error');
        return;
      }
      
      checkboxes.forEach((cb, index) => {
        const fileIndex = parseInt(cb.dataset.index);
        const file = processedFiles[fileIndex];
        setTimeout(() => {
          downloadFile(file.url, file.name);
        }, index * 500);
      });
      
      log(`下载选中的 ${checkboxes.length} 个文件`);
    }

    // 预览文件
    function previewFile(fileIndex) {
      const file = processedFiles[fileIndex];
      if (!file || !file.group) return;
      
      const modal = document.getElementById('previewModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalStats = document.getElementById('modalStats');
      const modalBody = document.getElementById('modalBody');
      
      const userId = userIdInput.value || 'User';
      const assistantId = assistantIdInput.value || 'Gemini';
      
      // 计算统计信息
      const group = file.group;
      const totalChars = group.conversations.reduce((sum, conv) => {
        return sum + (conv.userMessage?.length || 0) + (conv.aiMessage?.length || 0);
      }, 0);
      
      // 设置模态框内容
      modalTitle.textContent = `对话记录预览 - ${file.startDate}${file.startDate !== file.endDate ? ` 至 ${file.endDate}` : ''}`;
      modalStats.innerHTML = `${group.conversations.length} 条对话 | ${totalChars} 字符`;
      
      // 生成对话HTML
      let conversationHTML = '';
      group.conversations.forEach((conversation, index) => {
        const timestamp = new Date(conversation.timestamp).toLocaleString('zh-CN');
        
        conversationHTML += `
          <div class="conversation-item">
            <div class="conversation-header">
              对话 ${index + 1} - ${timestamp}
            </div>
        `;
        
        if (conversation.userMessage) {
          if (conversation.isSystemPrompt) {
            conversationHTML += `
              <div class="message-bubble system-bubble">
                <div class="message-label">系统预设</div>
                <div class="message-content">${escapeHtml(conversation.userMessage)}</div>
              </div>
            `;
          } else {
            conversationHTML += `
              <div class="message-bubble user-bubble">
                <div class="message-label">${userId}</div>
                <div class="message-content">${escapeHtml(conversation.userMessage)}</div>
              </div>
            `;
          }
        }
        
        if (conversation.aiMessage) {
          conversationHTML += `
            <div class="message-bubble ai-bubble">
              <div class="message-label">${assistantId}</div>
              <div class="message-content">${escapeHtml(conversation.aiMessage)}</div>
            </div>
          `;
        }
        
        conversationHTML += `</div>`;
      });
      
      modalBody.innerHTML = conversationHTML;
      modal.style.display = 'block';
      
      setTimeout(() => {
        modal.style.opacity = '1';
      }, 10);
    }
    
    // HTML转义
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // 关闭模态框
    function closeModal() {
      const modal = document.getElementById('previewModal');
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.display = 'none';
        document.getElementById('modalBody').innerHTML = '';
      }, 300);
    }

    // 下载文件
    function downloadFile(url, filename) {
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      log(`下载文件: ${filename}`);
    }
    
    // 下载所有文件
    function downloadAllFiles() {
      processedFiles.forEach((file, index) => {
        setTimeout(() => {
          downloadFile(file.url, file.name);
        }, index * 500);
      });
      log(`批量下载 ${processedFiles.length} 个文件`);
    }

    // 事件监听
    processBtn.addEventListener('click', processFile);

    // 全局函数
    window.downloadFile = downloadFile;
    window.previewFile = previewFile;
    window.closeModal = closeModal;
    window.downloadAllFiles = downloadAllFiles;
    window.selectAllFiles = selectAllFiles;
    window.deselectAllFiles = deselectAllFiles;
    window.downloadSelectedFiles = downloadSelectedFiles;
    window.updateSelectedCount = updateSelectedCount;
    
    // 点击模态框外部关闭
    window.addEventListener('click', (event) => {
      const modal = document.getElementById('previewModal');
      if (event.target === modal) {
        closeModal();
      }
    });

    // 清理
    window.addEventListener('beforeunload', () => {
      processedFiles.forEach(file => {
        URL.revokeObjectURL(file.url);
      });
    });

    // 初始化
    log('Gemini活动记录分组工具已加载');
    log('功能: 隐私安全 | 智能解析 | 时区转换 | 批量导出 | 自定义ID');
  </script>
</body>
</html>